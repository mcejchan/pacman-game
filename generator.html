<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PacMan Map Generator - Náhodný labyrint</title>
    <style>
        body {
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        #map-display {
            display: inline-block;
            background-color: #000;
            border: 3px solid #00f;
            margin: 20px 0;
            position: relative;
        }
        
        .cell {
            position: absolute;
            width: 40px;
            height: 40px;
            box-sizing: border-box;
        }
        
        .wall-top {
            border-top: 3px solid #00f;
        }
        
        .wall-left {
            border-left: 3px solid #00f;
        }
        
        .dot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background-color: #ffff00;
            border-radius: 50%;
        }
        
        .power-pellet::after {
            width: 18px;
            height: 18px;
            background-color: #ffff00;
            border-radius: 50%;
            animation: pulse 0.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 10px #ffff00;
            }
            to { 
                transform: translate(-50%, -50%) scale(1.2);
                box-shadow: 0 0 20px #ffff00, 0 0 30px #ffff00;
            }
        }
        
        .pacman-spawn {
            background-color: rgba(255, 255, 0, 0.2);
        }
        
        .ghost-spawn {
            background-color: rgba(255, 0, 255, 0.2);
        }
        
        .spawn-marker {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .inaccessible {
            background-color: rgba(255, 0, 0, 0.3);
        }
        
        .info {
            margin: 20px 0;
            font-size: 14px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-box {
            width: 40px;
            height: 40px;
            border: 1px solid #333;
            position: relative;
        }
        
        button {
            background-color: #00f;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        button:hover {
            background-color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PacMan Map - Náhodný labyrint</h1>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box wall-top wall-left"></div>
                <span>Zeď nahoře + vlevo</span>
            </div>
            <div class="legend-item">
                <div class="legend-box dot"></div>
                <span>Tečka</span>
            </div>
            <div class="legend-item">
                <div class="legend-box power-pellet"></div>
                <span>Power Pellet</span>
            </div>
            <div class="legend-item">
                <div class="legend-box pacman-spawn"><span class="spawn-marker">P</span></div>
                <span>Spawn PacMana</span>
            </div>
            <div class="legend-item">
                <div class="legend-box ghost-spawn"><span class="spawn-marker">G</span></div>
                <span>Spawn duchů</span>
            </div>
        </div>
        
        <button onclick="generateNewMap()">Generovat novou mapu</button>
        
        <div id="map-display"></div>
        
        <div class="info">
            <h3>Bitová reprezentace:</h3>
            <p>WALL_TOP = 1, WALL_LEFT = 2, DOT = 4, POWER_PELLET = 8</p>
            <p>PACMAN_SPAWN = 16, GHOST_SPAWN = 32</p>
        </div>
        
        <pre id="map-data"></pre>
    </div>

    <script>
        // Konstanty pro bitovou reprezentaci
        const WALL_TOP = 1;
        const WALL_LEFT = 2;
        const DOT = 4;
        const POWER_PELLET = 8;
        const PACMAN_SPAWN = 16;
        const GHOST_SPAWN = 32;

        const BOARD_WIDTH = 18;
        const BOARD_HEIGHT = 12;
        const CELL_SIZE = 40;
        const WALL_PROBABILITY = 0.55;

        // Krok 1: Náhodné generování zdí
        function generateRandomWalls() {
            const map = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(0));
            
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    if (Math.random() < WALL_PROBABILITY) {
                        map[y][x] |= WALL_TOP;
                    }
                    if (Math.random() < WALL_PROBABILITY) {
                        map[y][x] |= WALL_LEFT;
                    }
                }
            }
            
            return map;
        }

        // Krok 2: Uzavření okrajů
        function sealBorders(map) {
            // Horní řada
            for (let x = 0; x < BOARD_WIDTH; x++) {
                map[0][x] |= WALL_TOP;
            }
            
            // Spodní řada - přidat zeď nad spodní řadou
            for (let x = 0; x < BOARD_WIDTH; x++) {
                if (BOARD_HEIGHT - 1 < BOARD_HEIGHT) {
                    map[BOARD_HEIGHT - 1][x] |= WALL_TOP;
                }
            }
            
            // Levý sloupec
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                map[y][0] |= WALL_LEFT;
            }
            
            // Pravý sloupec - přidat zeď vlevo od pravého sloupce
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                if (BOARD_WIDTH - 1 < BOARD_WIDTH) {
                    map[y][BOARD_WIDTH - 1] |= WALL_LEFT;
                }
            }
        }

        // Krok 3: Vytvoření okrajové cesty
        function createPerimeterPath(map) {
            // Levý sloupec - odstranit horizontální zdi kromě horní
            for (let y = 1; y < BOARD_HEIGHT - 1; y++) {
                map[y][0] &= ~WALL_TOP;
            }
            
            // Horní řada - odstranit vertikální zdi kromě levé
            for (let x = 1; x < BOARD_WIDTH - 1; x++) {
                map[0][x] &= ~WALL_LEFT;
            }
            
            // Předposlední řada (dole) - odstranit horizontální zdi
            for (let x = 0; x < BOARD_WIDTH - 1; x++) {
                map[BOARD_HEIGHT - 2][x] &= ~WALL_TOP;
            }
            
            // Předposlední sloupec (vpravo) - odstranit vertikální zdi
            for (let y = 0; y < BOARD_HEIGHT - 1; y++) {
                map[y][BOARD_WIDTH - 2] &= ~WALL_LEFT;
            }
        }

        // Krok 4: Přidání spawn pointů a domku duchů
        function addSpawnPoints(map) {
            // PacMan spawn - náhodně v dolní polovině
            let pacX, pacY;
            const centerX = Math.floor(BOARD_WIDTH / 2);
            const centerY = Math.floor(BOARD_HEIGHT / 2);
            
            do {
                pacX = Math.floor(Math.random() * (BOARD_WIDTH - 2)) + 1;
                pacY = Math.floor(Math.random() * 3) + (BOARD_HEIGHT - 4);
            } while (Math.abs(pacX - centerX) <= 2 && Math.abs(pacY - centerY) <= 2);
            
            map[pacY][pacX] |= PACMAN_SPAWN;
            
            // Domeček duchů uprostřed 3x3
            for (let dy = -1; dy <= 1; dy++) {
                for (let dx = -1; dx <= 1; dx++) {
                    const x = centerX + dx;
                    const y = centerY + dy;
                    
                    if (x >= 0 && x < BOARD_WIDTH && y >= 0 && y < BOARD_HEIGHT) {
                        // Zdi kolem domečku
                        if (dy === -1) map[y][x] |= WALL_TOP;
                        if (dx === -1) map[y][x] |= WALL_LEFT;
                        if (dy === 1 && y + 1 < BOARD_HEIGHT) map[y + 1][x] |= WALL_TOP;
                        if (dx === 1 && x + 1 < BOARD_WIDTH) map[y][x + 1] |= WALL_LEFT;
                    }
                }
            }
            
            // Výjezd nahoru - odstranit horní zeď uprostřed
            map[centerY - 1][centerX] &= ~WALL_TOP;
            
            // Ghost spawny
            map[centerY][centerX] |= GHOST_SPAWN;
            if (centerX - 1 >= 0) map[centerY][centerX - 1] |= GHOST_SPAWN;
            if (centerX + 1 < BOARD_WIDTH) map[centerY][centerX + 1] |= GHOST_SPAWN;
            if (centerY + 1 < BOARD_HEIGHT) map[centerY + 1][centerX] |= GHOST_SPAWN;
            
            return { pacX, pacY, ghostX: centerX, ghostY: centerY - 1 };
        }

        // Kontrola dostupnosti pomocí flood fill
        function isReachableToPerimeter(map, startX, startY) {
            const visited = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(false));
            const queue = [[startX, startY]];
            visited[startY][startX] = true;
            
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                
                // Kontrola, zda jsme dosáhli okrajové cesty
                if (x === 0 || x === BOARD_WIDTH - 2 || y === 0 || y === BOARD_HEIGHT - 2) {
                    return true;
                }
                
                // Kontrola všech směrů
                if (canMove(map, x, y, 'UP') && y > 0 && !visited[y-1][x]) {
                    visited[y-1][x] = true;
                    queue.push([x, y-1]);
                }
                if (canMove(map, x, y, 'DOWN') && y < BOARD_HEIGHT-1 && !visited[y+1][x]) {
                    visited[y+1][x] = true;
                    queue.push([x, y+1]);
                }
                if (canMove(map, x, y, 'LEFT') && x > 0 && !visited[y][x-1]) {
                    visited[y][x-1] = true;
                    queue.push([x-1, y]);
                }
                if (canMove(map, x, y, 'RIGHT') && x < BOARD_WIDTH-1 && !visited[y][x+1]) {
                    visited[y][x+1] = true;
                    queue.push([x+1, y]);
                }
            }
            
            return false;
        }

        // Probourat cestu k okraji
        function breakPathToPerimeter(map, startX, startY) {
            const directions = ['UP', 'DOWN', 'LEFT', 'RIGHT'];
            let attempts = 0;
            
            while (!isReachableToPerimeter(map, startX, startY) && attempts < 100) {
                // Použít BFS k nalezení nejbližší zdi k proražení
                const visited = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(false));
                const queue = [[startX, startY, []]];
                visited[startY][startX] = true;
                let wallToBreak = null;
                
                while (queue.length > 0 && !wallToBreak) {
                    const [x, y, path] = queue.shift();
                    
                    // Zkusit všechny směry
                    for (const dir of directions) {
                        let nx = x, ny = y;
                        switch(dir) {
                            case 'UP': ny--; break;
                            case 'DOWN': ny++; break;
                            case 'LEFT': nx--; break;
                            case 'RIGHT': nx++; break;
                        }
                        
                        if (nx >= 0 && nx < BOARD_WIDTH && ny >= 0 && ny < BOARD_HEIGHT) {
                            if (!canMove(map, x, y, dir)) {
                                // Našli jsme zeď - zkontrolovat, jestli vede k novému prostoru
                                if (!visited[ny] || !visited[ny][nx]) {
                                    wallToBreak = { x, y, dir };
                                    break;
                                }
                            } else if (!visited[ny][nx]) {
                                visited[ny][nx] = true;
                                queue.push([nx, ny, [...path, {x, y, dir}]]);
                            }
                        }
                    }
                }
                
                // Prorazit zeď
                if (wallToBreak) {
                    switch(wallToBreak.dir) {
                        case 'UP':
                            map[wallToBreak.y][wallToBreak.x] &= ~WALL_TOP;
                            break;
                        case 'DOWN':
                            if (wallToBreak.y + 1 < BOARD_HEIGHT) 
                                map[wallToBreak.y + 1][wallToBreak.x] &= ~WALL_TOP;
                            break;
                        case 'LEFT':
                            map[wallToBreak.y][wallToBreak.x] &= ~WALL_LEFT;
                            break;
                        case 'RIGHT':
                            if (wallToBreak.x + 1 < BOARD_WIDTH) 
                                map[wallToBreak.y][wallToBreak.x + 1] &= ~WALL_LEFT;
                            break;
                    }
                }
                
                attempts++;
            }
        }

        // Detekce a oprava slepých uliček
        function fixDeadEnds(map) {
            // Najít všechny oblasti pomocí flood fill
            const visited = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(false));
            const regions = [];
            
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    if (!visited[y][x]) {
                        const region = floodFillRegion(map, x, y, visited);
                        if (region.cells.length > 0) {
                            regions.push(region);
                        }
                    }
                }
            }
            
            // Pro každou oblast zkontrolovat počet vstupů
            for (const region of regions) {
                if (region.cells.length >= 3 && region.cells.length < 30) {
                    const entries = countRegionEntries(map, region);
                    
                    if (entries.length === 1) {
                        // Slepá ulička - probourat náhodnou zeď
                        breakRandomWallInRegion(map, region);
                    }
                }
            }
        }

        function floodFillRegion(map, startX, startY, visited) {
            const region = { cells: [], borders: [] };
            const queue = [[startX, startY]];
            visited[startY][startX] = true;
            
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                region.cells.push({ x, y });
                
                // Kontrola všech směrů
                const directions = [
                    { dx: 0, dy: -1, dir: 'UP' },
                    { dx: 0, dy: 1, dir: 'DOWN' },
                    { dx: -1, dy: 0, dir: 'LEFT' },
                    { dx: 1, dy: 0, dir: 'RIGHT' }
                ];
                
                for (const { dx, dy, dir } of directions) {
                    const nx = x + dx;
                    const ny = y + dy;
                    
                    if (canMove(map, x, y, dir)) {
                        if (nx >= 0 && nx < BOARD_WIDTH && ny >= 0 && ny < BOARD_HEIGHT && !visited[ny][nx]) {
                            visited[ny][nx] = true;
                            queue.push([nx, ny]);
                        }
                    } else {
                        // Zeď - přidat do seznamu hranic
                        region.borders.push({ x, y, dir });
                    }
                }
            }
            
            return region;
        }

        function countRegionEntries(map, region) {
            const entries = [];
            const cellSet = new Set(region.cells.map(c => `${c.x},${c.y}`));
            
            for (const border of region.borders) {
                let nx = border.x, ny = border.y;
                
                switch(border.dir) {
                    case 'UP': ny--; break;
                    case 'DOWN': ny++; break;
                    case 'LEFT': nx--; break;
                    case 'RIGHT': nx++; break;
                }
                
                // Pokud soused není v regionu, je to vstup
                if (nx >= 0 && nx < BOARD_WIDTH && ny >= 0 && ny < BOARD_HEIGHT) {
                    if (!cellSet.has(`${nx},${ny}`)) {
                        entries.push(border);
                    }
                }
            }
            
            return entries;
        }

        function breakRandomWallInRegion(map, region) {
            if (region.borders.length === 0) return;
            
            // Vybrat náhodnou zeď k proboření
            const wall = region.borders[Math.floor(Math.random() * region.borders.length)];
            
            switch(wall.dir) {
                case 'UP':
                    map[wall.y][wall.x] &= ~WALL_TOP;
                    break;
                case 'DOWN':
                    if (wall.y + 1 < BOARD_HEIGHT) 
                        map[wall.y + 1][wall.x] &= ~WALL_TOP;
                    break;
                case 'LEFT':
                    map[wall.y][wall.x] &= ~WALL_LEFT;
                    break;
                case 'RIGHT':
                    if (wall.x + 1 < BOARD_WIDTH) 
                        map[wall.y][wall.x + 1] &= ~WALL_LEFT;
                    break;
            }
        }

        // Přidání teček
        function addDots(map, pacX, pacY) {
            const visited = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(false));
            const queue = [[pacX, pacY]];
            visited[pacY][pacX] = true;
            
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                
                // Přidat tečku pokud není spawn point
                if (!(map[y][x] & PACMAN_SPAWN) && !(map[y][x] & GHOST_SPAWN)) {
                    map[y][x] |= DOT;
                }
                
                // Kontrola všech směrů
                if (canMove(map, x, y, 'UP') && y > 0 && !visited[y-1][x]) {
                    visited[y-1][x] = true;
                    queue.push([x, y-1]);
                }
                if (canMove(map, x, y, 'DOWN') && y < BOARD_HEIGHT-1 && !visited[y+1][x]) {
                    visited[y+1][x] = true;
                    queue.push([x, y+1]);
                }
                if (canMove(map, x, y, 'LEFT') && x > 0 && !visited[y][x-1]) {
                    visited[y][x-1] = true;
                    queue.push([x-1, y]);
                }
                if (canMove(map, x, y, 'RIGHT') && x < BOARD_WIDTH-1 && !visited[y][x+1]) {
                    visited[y][x+1] = true;
                    queue.push([x+1, y]);
                }
            }
            
            // Power pellety v rozích
            const corners = [
                [1, 1],
                [BOARD_WIDTH-2, 1],
                [1, BOARD_HEIGHT-2],
                [BOARD_WIDTH-2, BOARD_HEIGHT-2]
            ];
            
            for (const [x, y] of corners) {
                if (visited[y][x] && !(map[y][x] & GHOST_SPAWN) && !(map[y][x] & PACMAN_SPAWN)) {
                    map[y][x] |= POWER_PELLET;
                    map[y][x] &= ~DOT;
                }
            }
            
            // Označit nedostupná místa
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    if (!visited[y][x]) {
                        map[y][x] |= 64;
                    }
                }
            }
        }

        function canMove(map, fromX, fromY, direction) {
            const cell = map[fromY][fromX];
            
            switch(direction) {
                case 'UP':
                    return !(cell & WALL_TOP);
                    
                case 'DOWN':
                    if (fromY + 1 >= BOARD_HEIGHT) return false;
                    return !(map[fromY + 1][fromX] & WALL_TOP);
                    
                case 'LEFT':
                    return !(cell & WALL_LEFT);
                    
                case 'RIGHT':
                    if (fromX + 1 >= BOARD_WIDTH) return false;
                    return !(map[fromY][fromX + 1] & WALL_LEFT);
            }
            return false;
        }

        // Hlavní funkce generování
        function generateMap() {
            // Krok 1: Náhodné zdi
            let map = generateRandomWalls();
            
            // Krok 2: Uzavřít okraje
            sealBorders(map);
            
            // Krok 3: Okrajová cesta
            createPerimeterPath(map);
            
            // Krok 4: Spawn pointy
            const { pacX, pacY, ghostX, ghostY } = addSpawnPoints(map);
            
            // Krok 5: Zkontrolovat dostupnost a případně probourat cesty
            breakPathToPerimeter(map, pacX, pacY);
            breakPathToPerimeter(map, ghostX, ghostY);
            
            // Krok 6: Opravit slepé uličky
            fixDeadEnds(map);
            
            // Krok 7: Přidat tečky
            addDots(map, pacX, pacY);
            
            return map;
        }

        function renderMap(map) {
            const display = document.getElementById('map-display');
            display.innerHTML = '';
            display.style.width = BOARD_WIDTH * CELL_SIZE + 'px';
            display.style.height = BOARD_HEIGHT * CELL_SIZE + 'px';
            
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.left = x * CELL_SIZE + 'px';
                    cell.style.top = y * CELL_SIZE + 'px';
                    
                    const value = map[y][x];
                    
                    if (value & WALL_TOP) cell.classList.add('wall-top');
                    if (value & WALL_LEFT) cell.classList.add('wall-left');
                    if (value & DOT) cell.classList.add('dot');
                    if (value & POWER_PELLET) cell.classList.add('power-pellet');
                    if (value & 64) cell.classList.add('inaccessible');
                    
                    if (value & PACMAN_SPAWN) {
                        cell.classList.add('pacman-spawn');
                        const marker = document.createElement('span');
                        marker.className = 'spawn-marker';
                        marker.textContent = 'P';
                        cell.appendChild(marker);
                    }
                    if (value & GHOST_SPAWN) {
                        cell.classList.add('ghost-spawn');
                        const marker = document.createElement('span');
                        marker.className = 'spawn-marker';
                        marker.textContent = 'G';
                        cell.appendChild(marker);
                    }
                    
                    // Vizuální okraje
                    if (y === BOARD_HEIGHT - 1) {
                        cell.style.borderBottom = '3px solid #00f';
                    }
                    if (x === BOARD_WIDTH - 1) {
                        cell.style.borderRight = '3px solid #00f';
                    }
                    
                    display.appendChild(cell);
                }
            }
        }

        function displayMapData(map) {
            const dataEl = document.getElementById('map-data');
            dataEl.textContent = 'const MAP = [\n';
            
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                dataEl.textContent += '    [';
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    const value = map[y][x] & ~64;
                    dataEl.textContent += value.toString().padStart(2);
                    if (x < BOARD_WIDTH - 1) dataEl.textContent += ',';
                }
                dataEl.textContent += ']';
                if (y < BOARD_HEIGHT - 1) dataEl.textContent += ',';
                dataEl.textContent += '\n';
            }
            
            dataEl.textContent += '];\n\n';
            
            // Statistiky
            let dotCount = 0;
            let pelletCount = 0;
            let accessibleCount = 0;
            
            for (let y = 0; y < BOARD_HEIGHT; y++) {
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    if (map[y][x] & DOT) dotCount++;
                    if (map[y][x] & POWER_PELLET) pelletCount++;
                    if (!(map[y][x] & 64)) accessibleCount++;
                }
            }
            
            dataEl.textContent += `// Konstanty:\n`;
            dataEl.textContent += `// const WALL_TOP = 1, WALL_LEFT = 2, DOT = 4, POWER_PELLET = 8;\n`;
            dataEl.textContent += `// const PACMAN_SPAWN = 16, GHOST_SPAWN = 32;\n\n`;
            dataEl.textContent += `// Statistiky:\n`;
            dataEl.textContent += `// Počet teček: ${dotCount}\n`;
            dataEl.textContent += `// Počet power pelletů: ${pelletCount}\n`;
            dataEl.textContent += `// Celkem k sebrání: ${dotCount + pelletCount}\n`;
            dataEl.textContent += `// Dostupných políček: ${accessibleCount} z ${BOARD_WIDTH * BOARD_HEIGHT}\n`;
            dataEl.textContent += `// Využití plochy: ${Math.round(accessibleCount / (BOARD_WIDTH * BOARD_HEIGHT) * 100)}%\n`;
        }

        function generateNewMap() {
            const map = generateMap();
            renderMap(map);
            displayMapData(map);
        }

        // První generování
        generateNewMap();
    </script>
</body>
</html>